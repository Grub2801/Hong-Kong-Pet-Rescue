app.controller('AdminShelterCtrl', ['Upload', '$scope', '$auth', '$http', 'ShelterAnimalFactory', '$stateParams', function (Upload, $scope, $auth, $http, ShelterAnimalFactory, $stateParams){
  var url = "<%= ENV['URL'] %>" || "http://localhost:3000";
  $scope.shelterAnimal = {};
  var ShelterAnimals = ShelterAnimalFactory;

  //show animals that belong to one shelter
  $scope.shelterAnimals = ShelterAnimals.query({shelterId:$stateParams.shelterId})

  $scope.displayEditButtons = function () {
    $scope.editing = true;
  }
  $scope.displayAddButton = function () {
    $scope.editing = false;
  }

  //delete an animal from a shelter
  $scope.deleteAnimal = function (id){
    ShelterAnimals.delete({shelterId: $stateParams.shelterId, id: id }, function (resp) {
      console.log(resp);
      var index = $scope.shelterAnimals.indexOf(id);
      $scope.shelterAnimals.splice(index, 1);
    }, function (resp) {
      console.log(resp);
    });
  }

  // fill the form to edit an animal
  $scope.editAnimal = function(animal){
    $scope.shelterAnimal = animal;
    console.log(animal)
  }

  // post a new animal
  $scope.addAnimal = function (id) {
    if ($scope.shelterAnimal.id) {
      var id = $scope.shelterAnimal.id;
      ShelterAnimals.update({shelterId: $stateParams.shelterId, id: id}, $scope.shelterAnimal, function (resp) {
        console.log(resp);
        $scope.shelterAnimal = {};
      }, function (resp) {
        console.log(resp);
      });
    } else {
      ShelterAnimals.save({shelterId: $stateParams.shelterId}, $scope.shelterAnimal, function (shelterAnimal) {
        console.log(shelterAnimal);
        $scope.shelterAnimals.push(shelterAnimal);
        $scope.shelterAnimal = {};
      }, function (resp) {
        console.log(resp);
      });
    }
  }

  // $scope.uploadFiles = function(file, errFiles) {
  //   $scope.f = file;
  //   $scope.errFile = errFiles && errFiles[0];
  //   if (file) {
  //     file.upload = Upload.upload({
  //       url: 'https://angular-file-upload-cors-srv.appspot.com/upload',
  //       data: {file: file}
  //     });
  //   }
  // }

  // upload later on form submit or something similar
  $scope.submit = function() {
   Upload.upload({
        url: url + '/api/shelters/' + $scope.shelterAnimal.shelter_id + '/animals/' + $scope.shelterAnimal.id,
        data: {file: $scope.shelterAnimal.avatar},
        method: 'PUT'
      }).then(function (resp) {
        console.log(resp);
      }, function (resp) {
        console.log('Error status: ' + resp.status);
      }, function (evt) {
        var progressPercentage = parseInt(100.0 * evt.loaded / evt.total);
        // console.log('progress: ' + progressPercentage + '% ' + evt.config.data.file.name);
      });
  };

  // upload on file select or drop
  $scope.upload = function () {

  };
}])